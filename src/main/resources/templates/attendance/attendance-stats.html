<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>
  <div class="d-flex align-items-center mb-3">
    <h2 class="fw-bold me-auto">근무 통계 리포트</h2>
    <a class="btn btn-sm btn-outline-secondary" th:href="@{/attendance}">근태 관리</a>
  </div>

  <div class="card p-3 shadow-sm mb-3">
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="border rounded p-3 h-100">
          <div class="fw-bold mb-2">최근 4일 이상 수</div>
          <canvas id="barChart" height="120"></canvas>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="border rounded p-3 h-100">
          <div class="fw-bold mb-2">통계</div>

          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold">어제</h6>
                    <span class="text-muted small"
                          th:text="${#temporals.format(yesterday, 'yyyy-MM-dd')}">
                      2025-12-28
                    </span>
                  </div>

                  <table class="table table-sm mb-0">
                    <tbody>
                      <tr><td>출근</td><td class="text-end fw-semibold" th:text="${yesterdayMap['NORMAL']}">0</td></tr>
                      <tr><td>지각</td><td class="text-end fw-semibold" th:text="${yesterdayMap['LATE']}">0</td></tr>
                      <tr><td>결근</td><td class="text-end fw-semibold" th:text="${yesterdayMap['ABSENT']}">0</td></tr>
                      <tr><td>연차</td><td class="text-end fw-semibold" th:text="${yesterdayMap['ANNUAL']}">0</td></tr>
                      <tr><td>병가</td><td class="text-end fw-semibold" th:text="${yesterdayMap['SICK']}">0</td></tr>
                      <tr><td>출장</td><td class="text-end fw-semibold" th:text="${yesterdayMap['BUSINESS']}">0</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold">오늘</h6>
                    <span class="text-muted small"
                          th:text="${#temporals.format(today, 'yyyy-MM-dd')}">
                      2025-12-29
                    </span>
                  </div>

                  <table class="table table-sm mb-0">
                    <tbody>
                      <tr><td>출근</td><td class="text-end fw-semibold" th:text="${todayMap['NORMAL']}">0</td></tr>
                      <tr><td>지각</td><td class="text-end fw-semibold" th:text="${todayMap['LATE']}">0</td></tr>
                      <tr><td>결근</td><td class="text-end fw-semibold" th:text="${todayMap['ABSENT']}">0</td></tr>
                      <tr><td>연차</td><td class="text-end fw-semibold" th:text="${todayMap['ANNUAL']}">0</td></tr>
                      <tr><td>병가</td><td class="text-end fw-semibold" th:text="${todayMap['SICK']}">0</td></tr>
                      <tr><td>출장</td><td class="text-end fw-semibold" th:text="${todayMap['BUSINESS']}">0</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 검색창을 여기로 이동 -->
  <div class="card p-3 shadow-sm mb-3">
    <form class="row g-2 align-items-center mb-0" method="get" th:action="@{/attendance-stats}">
      <div class="col-auto">
        <select class="form-select form-select-sm" name="deptId">
          <option value="">부서 전체</option>
          <option th:each="d : ${departments}" th:value="${d.deptId}" th:text="${d.name}"
                  th:selected="${d.deptId == selectedDeptId}"></option>
        </select>
      </div>

      <div class="col-auto">
        <select class="form-select form-select-sm" name="rankId">
          <option value="">직급 전체</option>
          <option th:each="r : ${ranks}" th:value="${r.positionId}" th:text="${r.name}"
                  th:selected="${r.positionId == selectedRankId}"></option>
        </select>
      </div>

      <!-- 년 월 달력 입력 -->
      <div class="col-auto">
        <input type="month"
               class="form-control form-control-sm"
               name="yearMonth"
               th:value="${param.yearMonth}">
      </div>
	  
	  <!-- 이름/직원ID 선택 -->
	  <div class="col-auto">
	    <select class="form-select form-select-sm" name="searchField">
	      <option value="name" th:selected="${param.searchField == 'name' or #strings.isEmpty(param.searchField)}">이름</option>
	      <option value="id" th:selected="${param.searchField == 'id'}">직원ID</option>
	    </select>
	  </div>

	  <!-- 입력 -->
	  <div class="col-auto">
	    <input type="text"
	           class="form-control form-control-sm"
	           name="keyword"
	           placeholder="검색어 입력"
	           th:value="${param.keyword}">
	  </div>

      <div class="col-auto">
        <button class="btn btn-outline-secondary btn-sm" type="submit">조회</button>
      </div>
    </form>
  </div>

  <div class="card p-3 shadow-sm">
    <div class="d-flex align-items-center mb-2">
      <div class="fw-bold">직원별 통계</div>
      <div class="ms-auto text-muted small"
           th:text="${selectedYear + '년 ' + selectedMonth + '월'}"></div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
        <tr>
          <th>직원ID</th>
          <th>이름</th>
          <th>부서</th>
          <th>출근</th>
          <th>지각</th>
          <th>결근</th>
          <th>연차</th>
          <th>초과근무 분</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r : ${employeeStats}">
          <td th:text="${r.employeeId}"></td>
          <td th:text="${r.name}"></td>
          <td th:text="${r.deptName}"></td>
          <td th:text="${r.normalCount}"></td>
          <td th:text="${r.lateCount}"></td>
          <td th:text="${r.absentCount}"></td>
          <td th:text="${r.annualCount}"></td>
          <td th:text="${r.overtimeMinutes}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(employeeStats)}">
          <td colspan="8" class="text-center text-muted">데이터 없음</td>
        </tr>
        </tbody>
      </table>
    </div>

	<!-- 직원별 통계 페이징 -->
	<nav class="mt-3">
	  <ul class="pagination pagination-sm justify-content-center mb-0"
	      th:with="
	        tp=${totalPages == null ? 1 : totalPages},
	        cp=${currentPage == null ? 1 : currentPage},
	        start=${(cp - 2) < 1 ? 1 : (cp - 2)},
	        end=${(cp + 2) > tp ? tp : (cp + 2)}
	      ">

	    <!-- 이전 -->
	    <li class="page-item" th:classappend="${cp <= 1} ? ' disabled' : ''">
	      <a class="page-link"
	         th:href="@{/attendance-stats(
	           deptId=${selectedDeptId},
	           rankId=${selectedRankId},
	           yearMonth=${param.yearMonth},
	           searchField=${param.searchField},
	           keyword=${param.keyword},
	           page=${cp - 1}
	         )}">
	        이전
	      </a>
	    </li>

	    <!-- 1 페이지로 -->
	    <li class="page-item" th:if="${start > 1}">
	      <a class="page-link"
	         th:href="@{/attendance-stats(
	           deptId=${selectedDeptId},
	           rankId=${selectedRankId},
	           yearMonth=${param.yearMonth},
	           searchField=${param.searchField},
	           keyword=${param.keyword},
	           page=1
	         )}">1</a>
	    </li>

	    <li class="page-item disabled" th:if="${start > 2}">
	      <span class="page-link">...</span>
	    </li>

	    <!-- 현재 구간 페이지들 -->
	    <li class="page-item"
	        th:each="p : ${#numbers.sequence(start, end)}"
	        th:classappend="${p == cp} ? ' active' : ''">
	      <a class="page-link"
	         th:href="@{/attendance-stats(
	           deptId=${selectedDeptId},
	           rankId=${selectedRankId},
	           yearMonth=${param.yearMonth},
	           searchField=${param.searchField},
	           keyword=${param.keyword},
	           page=${p}
	         )}"
	         th:text="${p}">1</a>
	    </li>

	    <li class="page-item disabled" th:if="${end < tp - 1}">
	      <span class="page-link">...</span>
	    </li>

	    <!-- 마지막 페이지로 -->
	    <li class="page-item" th:if="${end < tp}">
	      <a class="page-link"
	         th:href="@{/attendance-stats(
	           deptId=${selectedDeptId},
	           rankId=${selectedRankId},
	           yearMonth=${param.yearMonth},
	           searchField=${param.searchField},
	           keyword=${param.keyword},
	           page=${tp}
	         )}"
	         th:text="${tp}">10</a>
	    </li>

	    <!-- 다음 -->
	    <li class="page-item" th:classappend="${cp >= tp} ? ' disabled' : ''">
	      <a class="page-link"
	         th:href="@{/attendance-stats(
	           deptId=${selectedDeptId},
	           rankId=${selectedRankId},
	           yearMonth=${param.yearMonth},
	           searchField=${param.searchField},
	           keyword=${param.keyword},
	           page=${cp + 1}
	         )}">
	        다음
	      </a>
	    </li>

	  </ul>
	</nav>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script th:inline="javascript">
    const barLabels = /*[[${recent4MonthsLabels}]]*/ [];
    const barCounts = /*[[${recent4MonthsValues}]]*/ [];

    const ctx = document.getElementById("barChart");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: barLabels,
        datasets: [{
          label: "근태 이상 수",
          data: barCounts
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>
</section>
</body>
</html>
