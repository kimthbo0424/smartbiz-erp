<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>

<section>
  <h2 class="fw-bold mb-4">입출고 이력</h2>

  <!-- 검색 -->
  <form class="row g-2 mb-3" onsubmit="return false;">
    <div class="col-md-3">
      <input type="text" id="searchKeyword"
             class="form-control form-control-sm"
             placeholder="상품ID 검색">
    </div>

    <div class="col-md-3">
      <select id="warehouseSelect" class="form-select form-select-sm">
        <option value="">창고 선택</option>
      </select>
    </div>

    <div class="col-md-3">
      <button type="button" onclick="loadTransactions(0)"
              class="btn btn-sm btn-primary">검색</button>
      <a href="/inventory/inout/form"
         class="btn btn-sm btn-outline-secondary">입출고 등록</a>
    </div>
  </form>

  <!-- 테이블 -->
  <div class="table-responsive bg-white rounded shadow-sm">
    <table class="table table-hover align-middle">
      <thead class="table-light">
      <tr>
        <th>날짜</th>
        <th>상품ID</th>
        <th>구분</th>
        <th>수량</th>
        <th>사유</th>
        <th>취소</th>
      </tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
  </div>

  <div id="paginationArea" class="mt-3 text-center"></div>

<script>
  let currentPage = 0;

  document.addEventListener("DOMContentLoaded", () => {
    loadWarehouses();
  });

  async function loadWarehouses() {
    const res = await fetch("/api/warehouse");
    const result = await res.json();

    if (!result.success) return;

    const select = document.getElementById("warehouseSelect");
    result.data.forEach(w => {
      select.insertAdjacentHTML(
        "beforeend",
        `<option value="${w.id}">${w.name}</option>`
      );
    });
  }

  async function loadTransactions(page = 0) {
    const warehouseId = document.getElementById("warehouseSelect").value;
    const keyword = document.getElementById("searchKeyword").value.trim();

    if (!warehouseId) {
      alert("창고를 선택하세요.");
      return;
    }

    currentPage = page;

    const res = await fetch(
      `/api/inventory/moves/inout?warehouseId=${warehouseId}&page=${page}&size=10`
    );
    const result = await res.json();

    if (!result.success) {
      alert("조회 실패");
      return;
    }

    renderTransactions(result.data.content, keyword);
    renderPagination(result.data);
  }

  async function renderTransactions(list, keyword) {
    const tbody = document.getElementById("txBody");
    tbody.innerHTML = "";

    for (const tx of list) {
      if (keyword && !String(tx.productId).includes(keyword)) continue;

      const badge =
        tx.type === "IN"
          ? `<span class="badge bg-success">입고</span>`
          : `<span class="badge bg-danger">출고</span>`;

      const cancelInfo = await checkCancelable(tx.id);

      const cancelBtn = cancelInfo.cancelable
        ? `<button class="btn btn-sm btn-outline-danger"
                   onclick="cancelTransaction(${tx.id})">취소</button>`
        : `<button class="btn btn-sm btn-secondary" disabled
                   title="${cancelInfo.reason}">불가</button>`;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${tx.occurredAt.replace("T"," ")}</td>
          <td>${tx.productId}</td>
          <td>${badge}</td>
          <td>${tx.quantity}</td>
          <td>${tx.reason ?? "-"}</td>
          <td>${cancelBtn}</td>
        </tr>
      `);
    }
  }

  async function checkCancelable(id) {
    const res = await fetch(`/api/inventory/transactions/${id}/cancelable`);
    const result = await res.json();
    return result.data;
  }

  async function cancelTransaction(id) {
    const reason = prompt("취소 사유를 입력하세요");
    if (!reason) return;

    const res = await fetch("/api/inventory/cancel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        transactionId: id,
        reason: reason
      })
    });

    const result = await res.json();

    if (!result.success) {
      alert(result.message || "취소 실패");
      return;
    }

    alert("취소 완료");
    loadTransactions(currentPage);
  }

  function renderPagination(pageData) {
    let html = "";
    for (let i = 0; i < pageData.totalPages; i++) {
      html += `
        <button class="btn btn-sm ${i === pageData.number ? 'btn-primary' : 'btn-outline-primary'}"
                onclick="loadTransactions(${i})">
          ${i + 1}
        </button>
      `;
    }
    document.getElementById("paginationArea").innerHTML = html;
  }
</script>
</section>

</body>
</html>
