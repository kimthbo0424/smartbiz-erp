<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>

<h2 class="fw-bold mb-4">상품 수정</h2>

<div class="card p-4 shadow-sm">

    <div class="mb-3">
        <label class="form-label">상품명</label>
        <input type="text" class="form-control" id="name">
    </div>

    <div class="mb-3">
        <label class="form-label">SKU</label>
        <input type="text" class="form-control" id="sku">
    </div>

    <div class="mb-3">
        <label class="form-label">바코드</label>
        <input type="text" class="form-control" id="barcode">
    </div>

    <div class="mb-3">
        <label class="form-label">단가</label>
        <input type="number" step="0.01" class="form-control" id="unitPrice">
    </div>

    <div class="mb-3">
        <label class="form-label">원가</label>
        <input type="number" step="0.01" class="form-control" id="costPrice">
    </div>

    <div class="mb-3">
        <label class="form-label">상태</label>
        <select id="status" class="form-select">
            <option value="ACTIVE">ACTIVE</option>
            <option value="DISCONTINUED">DISCONTINUED</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">카테고리</label>
        <select id="categoryId" class="form-select"></select>
    </div>

    <div class="mb-3">
        <label class="form-label">기본 공급사</label>
        <select id="supplierId" class="form-select">
            <option value="">(선택 없음)</option>
        </select>
    </div>

    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="isActive">
        <label class="form-check-label">활성화</label>
    </div>

    <div class="d-flex justify-content-between">
        <a href="/product/list" class="btn btn-secondary">취소</a>
        <button class="btn btn-primary" onclick="updateProduct()">저장</button>
    </div>

</div>

<script>
const productId = location.pathname.split("/").pop();

document.addEventListener("DOMContentLoaded", loadData);

async function loadData() {
    const res = await fetch(`/api/products/${productId}`);
    const p = (await res.json()).data;

    document.getElementById("name").value = p.name;
    document.getElementById("sku").value = p.sku;
    document.getElementById("barcode").value = p.barcode ?? "";
    document.getElementById("unitPrice").value = p.unitPrice ?? "";
    document.getElementById("costPrice").value = p.costPrice ?? "";
    document.getElementById("status").value = p.status;
    document.getElementById("isActive").checked = p.isActive;

    loadCategories(p.categoryId);
    loadSuppliers(p.supplierId);
}

async function loadCategories(selectedId) {
    const res = await fetch("/api/categories");
    const list = (await res.json()).data;

    const select = document.getElementById("categoryId");
    list.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        if (c.id === selectedId) opt.selected = true;
        select.appendChild(opt);
    });
}

async function loadSuppliers(selectedId) {
    const res = await fetch("/api/clients");
    const list = (await res.json()).data;

    const select = document.getElementById("supplierId");
    list.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        if (c.id === selectedId) opt.selected = true;
        select.appendChild(opt);
    });
}

async function updateProduct() {
    const body = {
        name: document.getElementById("name").value,
        sku: document.getElementById("sku").value,
        barcode: document.getElementById("barcode").value || null,
        unitPrice: document.getElementById("unitPrice").value || null,
        costPrice: document.getElementById("costPrice").value || null,
        status: document.getElementById("status").value,
        categoryId: document.getElementById("categoryId").value,
        supplierId: document.getElementById("supplierId").value || null,
        isActive: document.getElementById("isActive").checked
    };

    const res = await fetch(`/api/products/${productId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    if (res.ok) {
        alert("수정 완료");
        location.href = `/product/detail/${productId}`;
    } else {
        alert("수정 실패");
    }
}
</script>

</section>
</body>
</html>
