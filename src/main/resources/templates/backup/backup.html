<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>
  <h2 class="fw-bold mb-3">데이터 백업</h2>

  <div class="card p-3 shadow-sm">
    <h5 class="fw-bold mb-2">백업</h5>

    <div class="small text-muted mb-2" th:if="${latestBackup != null}">
      마지막 백업
      <span th:text="${#temporals.format(latestBackup.backupTime, 'yyyy-MM-dd HH:mm')}"></span>
      /
      실행자
      <span th:text="${latestBackup.createdBy != null ? latestBackup.createdBy.name : '-'}"></span>
    </div>

    <div class="small text-muted mb-2" th:if="${latestBackup == null}">
      마지막 백업 없음
    </div>

	<form th:if="${session.auth != null and (session.auth <= 2 or session.auth == 4)}" id="backupForm" th:action="@{/backup/full}" method="post" class="d-inline">
	  <button class="btn btn-primary btn-sm" type="submit">백업 실행</button>
	</form>

	<script>
	(function () {
	  function clearCookie() {
	    document.cookie = "fileDownload=; Max-Age=0; Path=/";
	  }

	  function hasCookie() {
	    return document.cookie.indexOf("fileDownload=1") !== -1;
	  }

	  var form = document.getElementById("backupForm");
	  if (!form) return;

	  form.addEventListener("submit", function () {
	    clearCookie();

	    var timer = setInterval(function () {
	      if (hasCookie()) {
	        clearInterval(timer);
	        clearCookie();
	        // 다운로드 완료 후 목록 갱신된 페이지로 이동
	        window.location.href = "/backup/backup";
	      }
	    }, 300);
	  });
	})();
	</script>

    <hr>

    <h6 class="fw-bold mb-2">최근 백업 10건</h6>

    <div class="small text-muted" th:if="${#lists.isEmpty(backups)}">
      백업 이력이 없습니다
    </div>

    <div th:if="${!#lists.isEmpty(backups)}" class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
        <tr>
          <th>백업 날짜</th>
          <th>실행자</th>
          <th>백업 파일명</th>
          <th>파일 크기</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="b : ${backups}">
          <td th:text="${#temporals.format(b.backupTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${b.createdBy != null ? b.createdBy.name : '-'}"></td>
          <td th:text="${b.fileName}"></td>
          <td th:text="${b.fileSize == null ? '-' : #numbers.formatInteger(b.fileSize, 0, 'COMMA') + ' byte'}"></td>
        </tr>
        </tbody>
      </table>
    </div>

  </div>
</section>
</body>
</html>
