<!-- /ERP/src/main/resources/templates/orders/order_list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<section>

  <div class="d-flex align-items-center mb-4">
    <h2 class="fw-bold mb-0">주문 목록</h2>
    <div class="ms-auto">
      <a th:href="@{/orders/new}" class="btn btn-primary">주문 등록</a>
    </div>
  </div>

  <!-- 검색 필터 -->
  <form class="row mb-3 g-2 align-items-center" method="get" th:action="@{/orders}">
    <div class="col-md-3">
      <input type="text" class="form-control" name="partnerName"
             placeholder="거래처명 검색" th:value="${q.partnerName}">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" name="managerName"
             placeholder="담당자 검색" th:value="${q.managerName}">
    </div>
    <div class="col-md-2">
      <select class="form-select" name="status">
        <option value="" th:selected="${q.status == null || q.status == ''}">전체 상태</option>
        <option value="PENDING" th:selected="${q.status == 'PENDING'}">진행중</option>
        <option value="SHIPPED" th:selected="${q.status == 'SHIPPED'}">출고완료</option>
        <option value="SETTLED" th:selected="${q.status == 'SETTLED'}">정산완료</option>
        <option value="CANCELLED" th:selected="${q.status == 'CANCELLED'}">취소</option>
        <option value="RETURNED" th:selected="${q.status == 'RETURNED'}">반품</option>
      </select>
    </div>
    <div class="col-md-2">
      <input type="date" class="form-control" name="orderDate" th:value="${q.orderDate}">
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100" type="submit">검색</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead>
      <tr>
        <th style="width:56px;">#</th>
        <th style="width:170px;">주문번호</th>
        <th style="width:170px;">거래처</th>
        <th style="width:170px;">주문일</th>
        <th style="width:110px;">상태</th>
        <th style="width:130px;">금액</th>
        <th style="width:130px;">세금</th>
        <th style="width:110px;">할인</th>
        <th style="width:130px;">총액</th>
        <th style="width:90px;">이익률</th>
        <th style="width:220px;">액션</th>
      </tr>
      </thead>

      <tbody>
      <tr th:if="${#lists.isEmpty(orders)}">
        <td colspan="11" class="text-center text-muted py-4">조회된 주문이 없습니다.</td>
      </tr>

      <tr th:each="o, stat : ${orders}">
        <td th:text="${stat.count}">1</td>
        <td th:text="${o.orderNo}">ORD-20251112-001</td>

        <td>
          <div th:text="${o.partnerName}">홍길동상사</div>
          <small class="text-muted">
            담당자:
            <span th:text="${o.managerName}">김철수</span>
            <span th:if="${o.managerPhone != null && o.managerPhone != ''}">
              / <span th:text="${o.managerPhone}">010-1234-5678</span>
            </span>
          </small>
        </td>

        <td th:text="${o.orderDate}">2025-11-10</td>

        <td>
          <span class="badge"
                th:classappend="
                  ${o.status} == 'PENDING' ? ' bg-warning text-dark' :
                  (${o.status} == 'SHIPPED' ? ' bg-success' :
                  (${o.status} == 'SETTLED' ? ' bg-secondary' :
                  (${o.status} == 'CANCELLED' ? ' bg-danger' :
                  (${o.status} == 'RETURNED' ? ' bg-danger' : ' bg-light text-dark'))))"
                th:text="
                  ${o.status} == 'PENDING' ? '진행중' :
                  (${o.status} == 'SHIPPED' ? '출고완료' :
                  (${o.status} == 'SETTLED' ? '정산완료' :
                  (${o.status} == 'CANCELLED' ? '취소' :
                  (${o.status} == 'RETURNED' ? '반품' : o.status))))">
            진행중
          </span>
        </td>

        <td th:text="'₩' + ${#numbers.formatInteger(o.subtotal, 3, 'COMMA')}">₩3,000,000</td>
        <td th:text="'₩' + ${#numbers.formatInteger(o.tax, 3, 'COMMA')}">₩300,000</td>
        <td th:text="'₩' + ${#numbers.formatInteger(o.discount, 3, 'COMMA')}">₩0</td>
        <td th:text="'₩' + ${#numbers.formatInteger(o.total, 3, 'COMMA')}">₩3,300,000</td>
        <td th:text="${o.profitRate} + '%'">15%</td>

        <td>
          <a class="btn btn-sm btn-outline-primary mb-1"
             th:href="@{/orders/{id}(id=${o.id})}">상세</a>

          <a class="btn btn-sm btn-outline-secondary mb-1"
             th:href="@{/orders/{id}/edit(id=${o.id})}"
             th:if="${o.status == 'PENDING'}">수정</a>

          <form th:action="@{/orders/{id}/ship(id=${o.id})}" method="post" class="d-inline"
                th:if="${o.status == 'PENDING'}">
            <button type="submit" class="btn btn-sm btn-outline-success mb-1">출고</button>
          </form>

          <form th:action="@{/orders/{id}/cancel(id=${o.id})}" method="post" class="d-inline"
                th:if="${o.status == 'PENDING'}">
            <button type="submit" class="btn btn-sm btn-outline-danger mb-1">취소</button>
          </form>

          <form th:action="@{/orders/{id}/return(id=${o.id})}" method="post" class="d-inline"
                th:if="${o.status == 'SHIPPED'}">
            <button type="submit" class="btn btn-sm btn-outline-danger mb-1">반품</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item" th:classappend="${page.current == 1} ? ' disabled'">
        <a class="page-link"
           th:href="@{/orders(page=${page.current-1}, partnerName=${q.partnerName}, managerName=${q.managerName}, status=${q.status}, orderDate=${q.orderDate})}">
          이전
        </a>
      </li>

      <li class="page-item"
          th:each="p : ${#numbers.sequence(1, page.total)}"
          th:classappend="${p == page.current} ? ' active'">
        <a class="page-link"
           th:href="@{/orders(page=${p}, partnerName=${q.partnerName}, managerName=${q.managerName}, status=${q.status}, orderDate=${q.orderDate})}"
           th:text="${p}">1</a>
      </li>

      <li class="page-item" th:classappend="${page.current == page.total} ? ' disabled'">
        <a class="page-link"
           th:href="@{/orders(page=${page.current+1}, partnerName=${q.partnerName}, managerName=${q.managerName}, status=${q.status}, orderDate=${q.orderDate})}">
          다음
        </a>
      </li>
    </ul>
  </nav>

</section>
</html>
