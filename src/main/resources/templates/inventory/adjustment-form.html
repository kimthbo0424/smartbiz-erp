<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">

<body>
<section>
    <h2 class="fw-bold mb-4">ì¬ê³  ì¡°ì • ë“±ë¡</h2>

    <form id="adjustForm"
          class="bg-white p-4 rounded shadow-sm"
          onsubmit="submitAdjust(); return false;">

        <!-- ìƒí’ˆ -->
        <div class="mb-3">
            <label class="form-label">ìƒí’ˆ</label>
            <select id="productId" class="form-select" required>
                <option value="">ìƒí’ˆ ì„ íƒ</option>
            </select>
        </div>

        <!-- ì°½ê³  -->
        <div class="mb-3">
            <label class="form-label">ì°½ê³ </label>
            <select id="warehouseId" class="form-select" required>
                <option value="">ì°½ê³  ì„ íƒ</option>
            </select>
        </div>

        <!-- ì¡°ì • ìˆ˜ëŸ‰ (ì¦ê°ê°’) -->
        <div class="mb-3">
            <label class="form-label">ì¡°ì • ìˆ˜ëŸ‰ ( + ì¦ê°€ / - ê°ì†Œ )</label>
            <input type="number"
                   id="adjustQuantity"
                   class="form-control"
                   placeholder="ì˜ˆ: 20 ë˜ëŠ” -20"
                   required>
            <div class="form-text">
                ì…ë ¥í•œ ê°’ë§Œí¼ í˜„ì¬ ì¬ê³ ì— ë”í•´ì§€ê±°ë‚˜(+) ì°¨ê°ë©ë‹ˆë‹¤(-).
            </div>
        </div>

        <!-- ì‚¬ìœ  -->
        <div class="mb-3">
            <label class="form-label">ì‚¬ìœ </label>
            <input type="text"
                   id="reason"
                   class="form-control"
                   placeholder="ì˜ˆ: ë¶„ì‹¤, íŒŒì†, ì‹¤ì‚¬ ì¡°ì •">
        </div>

        <button type="submit" class="btn btn-primary">ë“±ë¡</button>
        <a href="/inventory/adjustment" class="btn btn-secondary">ì·¨ì†Œ</a>

        <!-- ğŸ”¥ ì¤‘ìš”: scriptëŠ” ë°˜ë“œì‹œ section ì•ˆ -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                loadProducts();
                loadWarehouses();
            });

            // ìƒí’ˆ ë¡œë“œ
            async function loadProducts() {
                try {
                    const res = await fetch("/api/products");
                    const products = await res.json();

                    const select = document.getElementById("productId");
                    select.innerHTML = `<option value="">ìƒí’ˆ ì„ íƒ</option>`;

                    products.forEach(p => {
                        const opt = document.createElement("option");
                        opt.value = p.productId;
                        opt.textContent = p.name;
                        select.appendChild(opt);
                    });
                } catch (e) {
                    console.error("ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨", e);
                    alert("ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            }

            // ì°½ê³  ë¡œë“œ
            async function loadWarehouses() {
                try {
                    const res = await fetch("/api/warehouse");
                    const warehouses = await res.json();

                    const select = document.getElementById("warehouseId");
                    select.innerHTML = `<option value="">ì°½ê³  ì„ íƒ</option>`;

                    warehouses.forEach(w => {
                        const opt = document.createElement("option");
                        opt.value = w.id;
                        opt.textContent = w.name;
                        select.appendChild(opt);
                    });
                } catch (e) {
                    console.error("ì°½ê³  ë¡œë“œ ì‹¤íŒ¨", e);
                    alert("ì°½ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            }

            // ì¬ê³  ì¡°ì •(ì¦ê°)
            async function submitAdjust() {
                const productId = document.getElementById("productId").value;
                const warehouseId = document.getElementById("warehouseId").value;
                const adjustQuantity = document.getElementById("adjustQuantity").value;
                const reason = document.getElementById("reason").value;

                if (!productId || !warehouseId || adjustQuantity === "") {
                    alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const data = {
                    productId: Number(productId),
                    warehouseId: Number(warehouseId),
                    adjustQuantity: Number(adjustQuantity),
                    reason: reason || null
                };

                if (Number.isNaN(data.productId) || Number.isNaN(data.warehouseId) || Number.isNaN(data.adjustQuantity)) {
                    alert("ì…ë ¥ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }

                try {
                    const res = await fetch("/api/inventory/adjust", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(data)
                    });

                    const result = await res.json().catch(() => null);

                    if (!res.ok) {
                        // 400/500 ë“±
                        alert("ì¡°ì • ì‹¤íŒ¨: " + (result?.message || ("HTTP " + res.status)));
                        return;
                    }

                    if (!result || result.success !== true) {
                        alert("ì¡°ì • ì‹¤íŒ¨: " + (result?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                        return;
                    }

                    alert("ì¬ê³  ì¡°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.href = "/inventory/adjustment";
                } catch (e) {
                    console.error(e);
                    alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        </script>

    </form>
</section>
</body>
</html>
