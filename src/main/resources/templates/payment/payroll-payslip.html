<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>
  <div class="d-flex align-items-center mb-3">
    <h2 class="fw-bold me-auto">급여 명세서</h2>
	<a th:href="@{/payroll}" class="btn btn-outline-secondary btn-sm">목록으로</a>
  </div>

  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body p-4">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="text-muted small">직원</div>
          <div class="fw-bold" th:text="${employeeName}">직원명</div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">지급연월</div>
          <div class="fw-bold"
               th:text="${payroll.year + '-' + #numbers.formatInteger(payroll.month, 2)}">
            2025-11
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">상태</div>
          <div>
            <span th:if="${payroll.status == 'UNCALC'}" class="badge bg-secondary">미계산</span>
            <span th:if="${payroll.status == 'CALCULATED'}" class="badge bg-warning text-dark">계산완료</span>
            <span th:if="${payroll.status == 'CONFIRMED'}" class="badge bg-success">확정</span>
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">기본급</div>
          <div class="fw-bold"
               th:text="${#numbers.formatDecimal(payroll.baseSalary, 0, 'COMMA', 0, 'POINT')}">
            0
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">총 수당</div>
          <div class="fw-bold"
               th:text="${#numbers.formatDecimal(payroll.totalAllowance, 0, 'COMMA', 0, 'POINT')}">
            0
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">총 공제</div>
          <div class="fw-bold"
               th:text="${#numbers.formatDecimal(payroll.totalDeduction, 0, 'COMMA', 0, 'POINT')}">
            0
          </div>
        </div>

        <div class="col-md-12">
          <div class="text-muted small">실지급액</div>
          <div class="fs-4 fw-bold"
               th:text="${#numbers.formatDecimal(payroll.netPay, 0, 'COMMA', 0, 'POINT')}">
            0
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-3">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 bg-white">
          <thead class="table-light">
          <tr>
            <th>유형</th>
            <th>항목</th>
            <th>계산방식</th>
            <th class="text-end">비율</th>
            <th class="text-end">금액</th>
          </tr>
          </thead>

          <tbody>
			<tr th:each="d : ${details}">
			  <td>
			    <span th:if="${d.itemTypeSnapshot != null and d.itemTypeSnapshot.name() == 'ALLOWANCE'}"
			          class="badge text-bg-success">수당</span>
			    <span th:if="${d.itemTypeSnapshot != null and d.itemTypeSnapshot.name() == 'DEDUCTION'}"
			          class="badge text-bg-danger">공제</span>
			  </td>

			  <td th:text="${d.itemNameSnapshot}">항목명</td>

			  <td>
			    <span th:if="${d.calcTypeSnapshot != null and d.calcTypeSnapshot.name() == 'FIXED'}">고정금액</span>
			    <span th:if="${d.calcTypeSnapshot != null and d.calcTypeSnapshot.name() == 'RATE'}">비율</span>
			  </td>

			  <td class="text-end"
			      th:text="${d.rate != null} ? ${#numbers.formatDecimal(d.rate, 1, 'POINT', 4, 'POINT')} : '-'">
			    -
			  </td>

			  <td class="text-end"
			      th:text="${#numbers.formatDecimal(d.amount, 0, 'COMMA', 0, 'POINT')}">
			    0
			  </td>
			</tr>

          <tr th:if="${#lists.isEmpty(details)}">
            <td colspan="5" class="text-center text-muted py-4">상세 항목이 없습니다</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div th:if="${editMode and payroll.status != 'CONFIRMED'}" class="card shadow-sm border-0 mb-3">
    <div class="card-body p-3">
      <div class="fw-bold mb-2">급여 항목 편집</div>

      <form th:action="@{/payroll/payslip/{id}/items(id=${payroll.payrollId})}" method="post">
        <div class="table-responsive" style="max-height:240px;">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width:60px;">선택</th>
              <th>항목</th>
              <th>유형</th>
              <th>계산</th>
              <th class="text-end">고정금액</th>
              <th class="text-end">비율</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="it : ${items}">
              <td>
                <input class="form-check-input"
                       type="checkbox"
                       name="itemIds"
                       th:value="${it.itemId}"
                       th:checked="${selectedItemIds != null and selectedItemIds.contains(it.itemId)}">
              </td>
              <td th:text="${it.itemName}">항목명</td>
              <td>
                <span th:text="${it.itemType != null and it.itemType.name() == 'ALLOWANCE' ? '수당' : '공제'}">유형</span>
              </td>
              <td>
                <span th:text="${it.calcType != null and it.calcType.name() == 'FIXED' ? '고정금액' : '비율'}">계산</span>
              </td>
              <td class="text-end"
                  th:text="${it.amount != null ? #numbers.formatDecimal(it.amount, 0, 'COMMA', 0, 'POINT') : '-'}">-</td>
              <td class="text-end"
                  th:text="${it.rate != null ? #numbers.formatDecimal(it.rate, 1, 'POINT', 4, 'POINT') : '-'}">-</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end mt-2">
          <button type="submit" class="btn btn-sm btn-primary">저장</button>
        </div>
      </form>

      <div class="text-muted small mt-2">
        저장하면 선택된 항목만 반영되어 수당 공제 합계가 다시 계산됩니다
      </div>
    </div>
  </div>
</section>
</body>
</html>
