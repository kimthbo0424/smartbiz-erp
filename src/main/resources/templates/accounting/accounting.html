<!-- src/main/resources/templates/accounting/accounting.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>

  <style>
    .small-muted { color:#6c757d; font-size: 0.9rem; }
    .form-section { background:#fff; padding:16px; border-radius:6px; box-shadow:0 0 0 1px rgba(0,0,0,0.03); }
  </style>

  <h2 class="mb-3 fw-bold">회계관리</h2>

  <div th:if="${journalError != null}" class="alert alert-danger" th:text="${journalError}">에러</div>
  <div th:if="${journalMessage != null}" class="alert alert-success" th:text="${journalMessage}">메시지</div>

  <div th:if="${accountError != null}" class="alert alert-danger" th:text="${accountError}">에러</div>
  <div th:if="${accountMessage != null}" class="alert alert-success" th:text="${accountMessage}">메시지</div>

  <div th:if="${expenseError != null}" class="alert alert-danger" th:text="${expenseError}">에러</div>
  <div th:if="${expenseMessage != null}" class="alert alert-success" th:text="${expenseMessage}">메시지</div>

  <!-- ✅ 마감 메시지 -->
  <div th:if="${closeError != null}" class="alert alert-danger" th:text="${closeError}">에러</div>
  <div th:if="${closeMessage != null}" class="alert alert-success" th:text="${closeMessage}">메시지</div>


  <!-- 상단 요약 카드 -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="form-section">
        <div class="small-muted">이번달 매출</div>
        <div class="h5 fw-bold"
             th:text="'₩' + ${#numbers.formatInteger(summary.monthSalesTotal, 3, 'COMMA')}">₩0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="form-section">
        <div class="small-muted">이번달 매입</div>
        <div class="h5 fw-bold"
             th:text="'₩' + ${#numbers.formatInteger(summary.monthPurchaseTotal, 3, 'COMMA')}">₩0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="form-section">
        <div class="small-muted">예상 VAT</div>
        <div class="h5 fw-bold"
             th:text="'₩' + ${#numbers.formatInteger(summary.expectedVat, 3, 'COMMA')}">₩0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="form-section">
        <div class="small-muted">미처리 건</div>
        <div class="h5 fw-bold"
             th:text="${summary.unprocessedCount}">0</div>
      </div>
    </div>
  </div>

  <!-- 탭 -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'trans' ? ' active' : ''"
              id="trans-tab" data-bs-toggle="tab" data-bs-target="#trans"
              type="button" role="tab">매출/매입 내역</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'profit' ? ' active' : ''"
              id="profit-tab" data-bs-toggle="tab" data-bs-target="#profit"
              type="button" role="tab">손익 리포트</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'journal' ? ' active' : ''"
              id="journal-tab" data-bs-toggle="tab" data-bs-target="#journal"
              type="button" role="tab">전표 관리</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'coa' ? ' active' : ''"
              id="coa-tab" data-bs-toggle="tab" data-bs-target="#coa"
              type="button" role="tab">계정과목</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'expense' ? ' active' : ''"
              id="expense-tab" data-bs-toggle="tab" data-bs-target="#expense"
              type="button" role="tab">비용 항목</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'fs' ? ' active' : ''"
              id="fs-tab" data-bs-toggle="tab" data-bs-target="#fs"
              type="button" role="tab">재무제표</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'vat' ? ' active' : ''"
              id="vat-tab" data-bs-toggle="tab" data-bs-target="#vat"
              type="button" role="tab">부가세/세금</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              th:classappend="${activeTab} == 'close' ? ' active' : ''"
              id="close-tab" data-bs-toggle="tab" data-bs-target="#close"
              type="button" role="tab">회계 마감</button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- 매출/매입 내역 -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'trans' ? ' show active' : ''"
         id="trans" role="tabpanel">

      <div class="mb-3 form-section">
        <form class="row g-2" method="get" th:action="@{/accounting}">
          <input type="hidden" name="tab" value="trans"/>
          <div class="col-md-3">
            <input type="text" class="form-control" name="partyName" placeholder="거래처명"
                   th:value="${q.partyName}">
          </div>
          <div class="col-md-2">
            <select class="form-select" name="type">
              <option value="" th:selected="${q.type == null || q.type == ''}">전체</option>
              <option value="sales" th:selected="${q.type == 'sales'}">매출</option>
              <option value="purchase" th:selected="${q.type == 'purchase'}">매입</option>
            </select>
          </div>
          <div class="col-md-2">
            <input type="date" class="form-control" name="from" th:value="${q.from}">
          </div>
          <div class="col-md-2">
            <input type="date" class="form-control" name="to" th:value="${q.to}">
          </div>
          <div class="col-md-3 text-end">
            <button class="btn btn-primary" type="submit">조회</button>
          </div>
        </form>
      </div>

      <div class="form-section">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th style="width:80px;">구분</th>
              <th>거래처</th>
              <th style="width:170px;">전표/문서번호</th>
              <th style="width:120px;">일자</th>
              <th class="text-end" style="width:140px;">공급가액</th>
              <th class="text-end" style="width:140px;">VAT</th>
              <th class="text-end" style="width:140px;">총액</th>
              <th style="width:120px;">결제/상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${rows == null || #lists.isEmpty(rows)}">
              <td colspan="9" class="text-center text-muted py-4">조회 결과가 없습니다.</td>
            </tr>

            <tr th:each="r, stat : ${rows}">
              <td th:text="${stat.count}">1</td>
              <td th:text="${r.typeLabel}">매출</td>
              <td th:text="${r.partyName}">홍길동상사</td>
              <td th:text="${r.voucherNo}">ORD-20251112-001</td>
              <td th:text="${r.date}">2025-11-01</td>
              <td class="text-end" th:text="'₩' + ${#numbers.formatInteger(r.subtotal, 3, 'COMMA')}">₩0</td>
              <td class="text-end" th:text="'₩' + ${#numbers.formatInteger(r.vat, 3, 'COMMA')}">₩0</td>
              <td class="text-end" th:text="'₩' + ${#numbers.formatInteger(r.total, 3, 'COMMA')}">₩0</td>
              <td>
                <span class="badge" th:classappend="${r.badgeClass}" th:text="${r.statusLabel}">상태</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 손익 리포트 -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'profit' ? ' show active' : ''"
         id="profit" role="tabpanel">

      <div class="form-section mb-3">
        <form class="row g-2" method="get" th:action="@{/accounting}">
          <input type="hidden" name="tab" value="profit"/>
          <div class="col-md-3">
            <label class="form-label small-muted mb-1">기간(From)</label>
            <input type="date" class="form-control" name="profitFrom" th:value="${pq.profitFrom}">
          </div>
          <div class="col-md-3">
            <label class="form-label small-muted mb-1">기간(To)</label>
            <input type="date" class="form-control" name="profitTo" th:value="${pq.profitTo}">
          </div>
          <div class="col-md-3">
            <label class="form-label small-muted mb-1">인식 기준</label>
            <select class="form-select" name="profitBasis">
              <option value="settled"
                      th:selected="${pq.profitBasis == null || pq.profitBasis == '' || pq.profitBasis == 'settled'}">
                결제완료(SETTLED)
              </option>
              <option value="shipped" th:selected="${pq.profitBasis == 'shipped'}">
                출고+결제(SHIPPED/SETTLED)
              </option>
              <option value="all" th:selected="${pq.profitBasis == 'all'}">
                전체(취소/반품 제외)
              </option>
            </select>
          </div>
          <div class="col-md-3 text-end">
            <label class="form-label small-muted mb-1">&nbsp;</label>
            <div>
              <button class="btn btn-primary" type="submit">조회</button>
            </div>
          </div>
        </form>
      </div>

      <div class="row g-3">
        <!-- ✅ 메모 박스 제거: col-md-8 → col-12 로 확장 -->
        <div class="col-12">
          <div class="form-section">
            <h6 class="fw-bold">요약</h6>
            <div class="row">
              <div class="col-md-6 mb-1">
                <div class="small-muted">매출(공급가액)</div>
                <div class="h5 fw-bold"
                     th:text="'₩' + ${#numbers.formatInteger(profitSummary.salesSubtotal, 3, 'COMMA')}">₩0</div>
              </div>
              <div class="col-md-6 mb-1">
                <div class="small-muted">VAT</div>
                <div class="h5 fw-bold"
                     th:text="'₩' + ${#numbers.formatInteger(profitSummary.salesVat, 3, 'COMMA')}">₩0</div>
              </div>

              <div class="col-md-6 mb-1">
                <div class="small-muted">매출총액</div>
                <div class="h5 fw-bold"
                     th:text="'₩' + ${#numbers.formatInteger(profitSummary.salesTotal, 3, 'COMMA')}">₩0</div>
              </div>

              <div class="col-md-6 mb-1">
                <div class="small-muted">매출총이익</div>
                <div class="h5 fw-bold"
                     th:text="'₩' + ${#numbers.formatInteger(profitSummary.grossProfit, 3, 'COMMA')}">₩0</div>
              </div>
              <div class="col-md-6 mb-1">
                <div class="small-muted">이익률</div>
                <div class="h5 fw-bold"
                     th:text="${#numbers.formatDecimal(profitSummary.profitRate, 1, 1)} + '%'">0.0%</div>
              </div>

              <div class="col-12 mt-2">
                <div class="small-muted">주문 건수: <span th:text="${profitSummary.orderCount}">0</span>건</div>
              </div>
            </div>

            <hr>

            <h6 class="fw-bold mt-2">상세(담당자별)</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th>담당자</th>
                  <th class="text-end">매출(공급가액)</th>
                  <th class="text-end">매출총이익</th>
                  <th class="text-end">이익률</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${profitRows == null || #lists.isEmpty(profitRows)}">
                  <td colspan="4" class="text-center text-muted py-3">조회 결과가 없습니다.</td>
                </tr>

                <tr th:each="r : ${profitRows}">
                  <td th:text="${r.label}">담당자</td>
                  <td class="text-end"
                      th:text="'₩' + ${#numbers.formatInteger(r.salesSubtotal, 3, 'COMMA')}">₩0</td>
                  <td class="text-end"
                      th:text="'₩' + ${#numbers.formatInteger(r.grossProfit, 3, 'COMMA')}">₩0</td>
                  <td class="text-end"
                      th:text="${#numbers.formatDecimal(r.profitRate, 1, 1)} + '%'">0.0%</td>
                </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- 전표 관리 -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'journal' ? ' show active' : ''"
         id="journal" role="tabpanel">

      <div class="row g-3">
        <!-- ✅ 가이드 박스 제거: col-md-8 → col-12 로 확장 -->
        <div class="col-12">
          <div class="form-section">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold mb-0">최근 전표</h6>
              <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#journalCreateBox">
                전표 등록
              </button>
            </div>

            <div class="collapse mb-3" id="journalCreateBox">
              <div class="border rounded p-3">
                <form th:action="@{/accounting/journals}" method="post" th:object="${journalForm}">

                  <div class="row g-2 mb-2">
                    <div class="col-md-4">
                      <label class="form-label small-muted mb-1">일자</label>
                      <input type="date" class="form-control" th:field="*{entryDate}">
                    </div>
                    <div class="col-md-8">
                      <label class="form-label small-muted mb-1">설명</label>
                      <input type="text" class="form-control" th:field="*{description}" placeholder="예: 12월 사무실 임대료">
                    </div>
                  </div>

                  <div class="table-responsive mb-2">
                    <table class="table table-sm align-middle">
                      <thead>
                      <tr>
                        <th style="width:210px;">계정과목</th>
                        <th style="width:140px;" class="text-end">차변</th>
                        <th style="width:140px;" class="text-end">대변</th>
                        <th>설명(선택)</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr th:each="line, stat : *{lines}">
                        <td>
                          <select class="form-select form-select-sm"
                                  th:name="${'lines[' + stat.index + '].accountId'}">
                            <option value="">선택</option>
                            <option th:each="a : ${accounts}"
                                    th:value="${a.id}"
                                    th:text="${a.label}"
                                    th:selected="${line.accountId != null && line.accountId == a.id}">
                              계정
                            </option>
                          </select>
                        </td>
                        <td class="text-end">
                          <input type="number" class="form-control form-control-sm text-end"
                                 th:name="${'lines[' + stat.index + '].debit'}"
                                 th:value="${line.debit}"
                                 placeholder="0">
                        </td>
                        <td class="text-end">
                          <input type="number" class="form-control form-control-sm text-end"
                                 th:name="${'lines[' + stat.index + '].credit'}"
                                 th:value="${line.credit}"
                                 placeholder="0">
                        </td>
                        <td>
                          <input type="text" class="form-control form-control-sm"
                                 th:name="${'lines[' + stat.index + '].description'}"
                                 th:value="${line.description}"
                                 placeholder="선택">
                        </td>
                      </tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="text-end">
                    <button type="submit" class="btn btn-success">저장(임시)</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th style="width:60px;">#</th>
                  <th style="width:170px;">전표번호</th>
                  <th style="width:120px;">일자</th>
                  <th>설명</th>
                  <th style="width:140px;">차변합</th>
                  <th style="width:140px;">대변합</th>
                  <th style="width:110px;">상태</th>
                  <th style="width:220px;">액션</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${journalRows == null || #lists.isEmpty(journalRows)}">
                  <td colspan="8" class="text-center text-muted py-4">전표가 없습니다.</td>
                </tr>

                <tr th:each="j, stat : ${journalRows}">
                  <td th:text="${stat.count}">1</td>
                  <td th:text="${j.journalNo}">JV-000001</td>
                  <td th:text="${j.date}">2025-11-12</td>
                  <td th:text="${j.description}">설명</td>
                  <td th:text="'₩' + ${#numbers.formatInteger(j.debitTotal, 3, 'COMMA')}">₩0</td>
                  <td th:text="'₩' + ${#numbers.formatInteger(j.creditTotal, 3, 'COMMA')}">₩0</td>
                  <td>
                    <span class="badge" th:classappend="${j.badgeClass}" th:text="${j.statusLabel}">임시</span>
                  </td>
                  <td>
                    <a class="btn btn-sm btn-outline-primary"
                       th:href="@{/accounting/journals/{id}(id=${j.id})}">보기</a>

                    <!-- ✅ (1) 미승인(DRAFT)만 노출
                         ✅ (2) latestClosedTo 이전 전표는 승인 버튼 숨김
                         - j.date, latestClosedTo: yyyy-MM-dd 문자열 비교(ISO 포맷) -->
                    <form th:action="@{/accounting/journals/{id}/post(id=${j.id})}"
                          method="post" class="d-inline"
                          th:if="${j.statusLabel == '미승인' and (latestClosedTo == null or (j.date != null and j.date > latestClosedTo))}">
                      <button type="submit" class="btn btn-sm btn-success">승인(확정)</button>
                    </form>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- 계정과목 -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'coa' ? ' show active' : ''"
         id="coa" role="tabpanel">

      <div class="row g-3">
        <div class="col-md-5">
          <div class="form-section">
            <h6 class="fw-bold">계정과목 등록</h6>

            <form method="post" th:action="@{/accounting/accounts}" th:object="${accountForm}">
              <div class="mb-2">
                <label class="form-label">계정 코드(선택)</label>
                <input type="number" class="form-control" th:field="*{id}" placeholder="예: 1000">
                <div class="small-muted mt-1">※ 미입력 시 자동 생성(정책에 따라 조정)</div>
              </div>

              <div class="mb-2">
                <label class="form-label">계정명</label>
                <input type="text" class="form-control" th:field="*{name}" placeholder="예: 현금">
              </div>

              <div class="mb-2">
                <label class="form-label">유형</label>
                <select class="form-select" th:field="*{type}">
                  <option value="" th:selected="*{type == null || type == ''}">선택</option>
                  <option th:each="t : ${accountTypeOptions}"
                          th:value="${t.value}"
                          th:text="${t.label}">유형</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">상위 계정(선택)</label>
                <select class="form-select" th:field="*{parentId}">
                  <option value="" th:selected="*{parentId == null}">- 없음 -</option>
                  <option th:each="a : ${accounts}"
                          th:value="${a.id}"
                          th:text="${a.label}">상위계정</option>
                </select>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" th:field="*{active}">
                <label class="form-check-label">사용</label>
              </div>

              <div class="text-end">
                <button class="btn btn-primary" type="submit">등록</button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-md-7">
          <div class="form-section">
            <h6 class="fw-bold">계정과목 목록</h6>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th style="width:110px;">코드</th>
                  <th>계정명</th>
                  <th style="width:120px;">유형</th>
                  <th>상위계정</th>
                  <th style="width:90px;">사용</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${accountRows == null || #lists.isEmpty(accountRows)}">
                  <td colspan="5" class="text-center text-muted py-4">등록된 계정과목이 없습니다.</td>
                </tr>

                <tr th:each="a : ${accountRows}">
                  <td th:text="${a.id}">1000</td>
                  <td th:text="${a.name}">현금</td>
                  <td th:text="${a.typeLabel}">자산</td>
                  <td th:text="${a.parentName == null || a.parentName == '' ? '-' : a.parentName}">-</td>
                  <td>
                    <span class="badge bg-success" th:if="${a.active}">Y</span>
                    <span class="badge bg-secondary" th:unless="${a.active}">N</span>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

            <div class="small-muted">
              ※ 1차는 등록/조회 중심이며, 수정/삭제/정렬 정책은 다음 단계에서 확장합니다.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ 비용 항목 -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'expense' ? ' show active' : ''"
         id="expense" role="tabpanel">

      <div class="row g-3">
        <div class="col-md-7">
          <div class="form-section">
            <h6 class="fw-bold">비용 항목 목록</h6>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th style="width:80px;">ID</th>
                  <th>항목명</th>
                  <th style="width:120px;">주기</th>
                  <th style="width:110px;">사용</th>
                  <th style="width:200px;">액션</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${expenseItems == null || #lists.isEmpty(expenseItems)}">
                  <td colspan="5" class="text-center text-muted py-4">비용 항목이 없습니다.</td>
                </tr>

                <tr th:each="it : ${expenseItems}">
                  <td th:text="${it.id}">1</td>
                  <td th:text="${it.name}">임대료</td>
                  <td>
                    <span class="badge bg-light text-dark border" th:text="${it.cycleLabel}">월별</span>
                  </td>
                  <td>
                    <span class="badge bg-success" th:if="${it.active}">Y</span>
                    <span class="badge bg-secondary" th:unless="${it.active}">N</span>
                  </td>
                  <td>
                    <form th:action="@{/accounting/expense-items/{id}/toggle(id=${it.id})}" method="post" class="d-inline">
                      <button class="btn btn-sm btn-outline-primary" type="submit">토글</button>
                    </form>
                    <form th:action="@{/accounting/expense-items/{id}/deactivate(id=${it.id})}" method="post" class="d-inline"
                          th:if="${it.active}">
                      <button class="btn btn-sm btn-outline-danger" type="submit">비활성</button>
                    </form>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>

        <div class="col-md-5">
          <div class="form-section">
            <h6 class="fw-bold">비용 항목 등록</h6>

            <form th:action="@{/accounting/expense-items}" method="post" th:object="${expenseForm}">
              <div class="mb-2">
                <label class="form-label">항목명</label>
                <input class="form-control" th:field="*{name}" placeholder="예: 임대료">
              </div>

              <div class="mb-2">
                <label class="form-label">주기</label>
                <select class="form-select" th:field="*{cycle}">
                  <option value="MONTHLY">월별</option>
                  <option value="ONCE">일시</option>
                </select>
                <div class="small-muted mt-1">※ ONCE(일시) / MONTHLY(월별)</div>
              </div>

              <div class="mb-2">
                <label class="form-label">설명(선택)</label>
                <input class="form-control" name="description" placeholder="선택 입력">
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" th:field="*{active}">
                <label class="form-check-label">사용</label>
              </div>

              <div class="text-end">
                <button class="btn btn-primary" type="submit">등록</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 재무제표 -->
    <div class="tab-pane fade" id="fs" role="tabpanel"
         th:classappend="${activeTab} == 'fs' ? ' show active' : ''">

      <div class="form-section mb-3">
        <form class="row g-2 align-items-end" method="get" th:action="@{/accounting}">
          <input type="hidden" name="tab" value="fs"/>

          <div class="col-md-3">
            <label class="form-label small-muted mb-1">대차 기준일</label>
            <input type="date" class="form-control" name="fsAsOf" th:value="${fsq.fsAsOf}">
          </div>

          <div class="col-md-3">
            <label class="form-label small-muted mb-1">손익 From</label>
            <input type="date" class="form-control" name="fsFrom" th:value="${fsq.fsFrom}">
          </div>

          <div class="col-md-3">
            <label class="form-label small-muted mb-1">손익 To</label>
            <input type="date" class="form-control" name="fsTo" th:value="${fsq.fsTo}">
          </div>

          <div class="col-md-3 text-end">
            <button class="btn btn-primary" type="submit">조회</button>
          </div>
        </form>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <div class="form-section">
            <h6>대차대조표 (요약)</h6>
            <table class="table table-sm">
              <tr>
                <td>자산</td>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(balanceSheet != null ? balanceSheet.assets : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <td>부채</td>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(balanceSheet != null ? balanceSheet.liabilities : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <td>자본</td>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(balanceSheet != null ? balanceSheet.equity : 0, 3, 'COMMA')}">₩0</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-section">
            <h6>손익계산서 (요약)</h6>
            <table class="table table-sm">
              <tr>
                <td>매출</td>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(incomeStatement != null ? incomeStatement.revenue : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <td>영업비용</td>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(incomeStatement != null ? incomeStatement.expense : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <td>영업이익</td>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(incomeStatement != null ? incomeStatement.operatingProfit : 0, 3, 'COMMA')}">₩0</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ 부가세/세금 (요약+조회 같은 라인 / 내역은 아래로 길게) -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'vat' ? ' show active' : ''"
         id="vat" role="tabpanel">

      <!-- 상단: 요약 + 조회(같은 라인) -->
      <div class="row g-3 mb-3">
        <!-- 요약 -->
        <div class="col-12 col-lg-7">
          <div class="form-section h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold mb-0">요약</h6>
              <div class="small-muted">
                (<span th:text="${vatSummary != null ? vatSummary.monthLabel : (vq != null ? vq.month : '')}">yyyy-MM</span>)
              </div>
            </div>

            <table class="table table-sm mb-0">
              <tr>
                <th style="width:160px;">매출 공급가액</th>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(vatSummary != null ? vatSummary.salesSubtotal : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <th>매출 VAT</th>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(vatSummary != null ? vatSummary.salesVat : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <th>매출 총액</th>
                <td class="text-end"
                    th:text="'₩' + ${#numbers.formatInteger(vatSummary != null ? vatSummary.salesTotal : 0, 3, 'COMMA')}">₩0</td>
              </tr>
              <tr>
                <th>매출 건수</th>
                <td class="text-end"
                    th:text="${vatSummary != null ? vatSummary.salesCount : 0} + '건'">0건</td>
              </tr>
              <tr class="table-light">
                <th>납부예상 VAT</th>
                <td class="text-end fw-bold"
                    th:text="'₩' + ${#numbers.formatInteger(vatSummary != null ? vatSummary.payableVat : 0, 3, 'COMMA')}">₩0</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- 조회 -->
        <div class="col-12 col-lg-5">
          <div class="form-section h-100">
            <h6 class="fw-bold mb-2">부가세/세금 조회</h6>

            <form class="row g-2 align-items-end" method="get" th:action="@{/accounting}">
              <input type="hidden" name="tab" value="vat"/>
              <div class="col-12">
                <label class="form-label small-muted mb-1">월 선택</label>
                <input type="month" class="form-control" name="month" th:value="${vq.month}">
              </div>

              <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                
            <div class="small-muted">
                  
                </div>
                <button class="btn btn-primary" type="submit">조회</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 아래: 내역을 길게(전체 폭) -->
      <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold mb-0">내역</h6>
          <div class="small-muted">단위: 원</div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
            <tr>
              <th style="width:120px;">일자</th>
              <th>거래처</th>
              <th style="width:180px;">주문번호</th>
              <th class="text-end" style="width:130px;">공급가</th>
              <th class="text-end" style="width:130px;">VAT</th>
              <th class="text-end" style="width:130px;">총액</th>
              <th style="width:120px;">상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${vatRows == null || #lists.isEmpty(vatRows)}">
              <td colspan="7" class="text-center text-muted py-4">조회 결과가 없습니다.</td>
            </tr>
            <tr th:each="r : ${vatRows}">
              <td th:text="${r.date}">2026-01-05</td>
              <td th:text="${r.partyName}">거래처</td>
              <td th:text="${r.voucherNo}">ORD-...</td>
              <td class="text-end" th:text="'₩' + ${#numbers.formatInteger(r.subtotal, 3, 'COMMA')}">₩0</td>
              <td class="text-end" th:text="'₩' + ${#numbers.formatInteger(r.vat, 3, 'COMMA')}">₩0</td>
              <td class="text-end" th:text="'₩' + ${#numbers.formatInteger(r.total, 3, 'COMMA')}">₩0</td>
              <td><span class="badge" th:classappend="${r.badgeClass}" th:text="${r.statusLabel}">상태</span></td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- 회계 마감 -->
    <div class="tab-pane fade"
         th:classappend="${activeTab} == 'close' ? ' show active' : ''"
         id="close" role="tabpanel">

      <div class="row g-3">
        <div class="col-md-5">
          <div class="form-section">
            <h6 class="fw-bold">마감 실행</h6>

            <form method="post" th:action="@{/accounting/close}" th:object="${closeForm}">
              <div class="mb-2">
                <label class="form-label small-muted mb-1">구분</label>
                <select class="form-select" th:field="*{type}">
                  <option value="MONTH">월 마감</option>
                  <option value="QUARTER">분기 마감</option>
                  <option value="YEAR">연 마감</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label small-muted mb-1">기간 키</label>
                <input class="form-control" th:field="*{period}" placeholder="예: 2026-01 / 2026-Q1 / 2026">
                <div class="small-muted mt-1">
                  MONTH: yyyy-MM / QUARTER: yyyy-Qn / YEAR: yyyy
                </div>
              </div>

              <div class="text-end">
                <button class="btn btn-danger" type="submit">마감 실행</button>
              </div>
            </form>

            <hr>

            <div class="small-muted">
              
            </div>
          </div>
        </div>

        <div class="col-md-7">
          <div class="form-section">
            <h6 class="fw-bold">마감 이력</h6>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th style="width:110px;">구분</th>
                  <th style="width:120px;">기간</th>
                  <th style="width:120px;">마감기준일</th>
                  <th style="width:160px;">처리일시</th>
                  <th style="width:120px;">사용자</th>
                  <th style="width:90px;">상태</th>
                  <th style="width:140px;">액션</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${closeHistory == null || #lists.isEmpty(closeHistory)}">
                  <td colspan="7" class="text-center text-muted py-4">마감 이력이 없습니다.</td>
                </tr>

                <tr th:each="c : ${closeHistory}">
                  <td th:text="${c.typeLabel}">월 마감</td>
                  <td th:text="${c.periodKey}">2026-01</td>
                  <td th:text="${c.closedTo}">2026-01-31</td>
                  <td th:text="${c.closedAt}">2026-01-05 13:40</td>
                  <td th:text="${c.closedBy}">admin</td>
                  <td><span class="badge" th:classappend="${c.badgeClass}" th:text="${c.statusLabel}">마감</span></td>
                  <td>
                    <form th:action="@{/accounting/close/{id}/reverse(id=${c.id})}" method="post" class="d-inline"
                          th:if="${c.statusLabel == '마감'}">
                      <button class="btn btn-sm btn-outline-secondary" type="submit">역마감</button>
                    </form>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

    </div>

  </div>
</section>

</body>
</html>