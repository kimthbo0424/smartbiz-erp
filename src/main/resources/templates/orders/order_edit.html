<!-- /ERP/src/main/resources/templates/orders/order_edit.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<section>

  <style>
    .form-section {
      background:#fff;
      padding:20px;
      border-radius:5px;
      box-shadow:0 0 5px rgba(0,0,0,0.1);
      margin-bottom:20px;
    }
  </style>

  <div class="d-flex align-items-center mb-4">
    <h2 class="fw-bold mb-0">주문 수정</h2>
    <div class="ms-auto">
      <a th:href="@{/orders}" class="btn btn-outline-secondary">목록</a>
    </div>
  </div>

  <form th:action="@{/orders/{id}/edit(id=${form.id})}" method="post" th:object="${form}">
    <!-- (Spring Security 적용 시)
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    -->

    <input type="hidden" th:field="*{id}">

    <!-- 거래처 / 담당자 -->
    <div class="form-section">
      <div class="row g-3">

        <div class="col-md-6">
          <label class="form-label">주문번호</label>
          <input type="text" class="form-control" th:field="*{orderNo}" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label">주문일</label>
          <input type="date" class="form-control" th:field="*{orderDate}">
        </div>

        <div class="col-md-6">
          <label class="form-label">거래처명</label>
          <input type="text" class="form-control"
                 placeholder="거래처명을 입력하세요"
                 th:field="*{partnerName}">
        </div>

        <div class="col-md-6">
          <label class="form-label">담당자명</label>
          <input type="text" class="form-control"
                 placeholder="담당자명을 입력하세요"
                 th:field="*{managerName}">
        </div>

        <div class="col-md-6">
          <label class="form-label">담당자 연락처</label>
          <input type="text" class="form-control"
                 placeholder="010-1234-5678"
                 th:field="*{managerPhone}">
        </div>

      </div>
    </div>

    <!-- 주문 상품 내역 -->
    <div class="form-section">
      <h5 class="mb-3">주문 상품 내역</h5>

      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead>
          <tr>
            <th style="width:60px;">#</th>
            <th>상품명</th>
            <th style="width:140px;">수량</th>
            <th style="width:160px;">단가</th>
            <th style="width:180px;">금액</th>
            <th style="width:110px;">액션</th>
          </tr>
          </thead>

          <tbody id="order-items">
          <tr th:each="it, stat : *{items}" class="item-row">
            <td class="row-no" th:text="${stat.count}">1</td>

            <td>
              <input type="text" class="form-control product-name"
                     placeholder="상품명"
                     th:field="*{items[__${stat.index}__].productName}">
            </td>

            <td>
              <input type="number" class="form-control qty"
                     min="1"
                     th:field="*{items[__${stat.index}__].qty}">
            </td>

            <td>
              <input type="number" class="form-control unit-price"
                     min="0"
                     th:field="*{items[__${stat.index}__].unitPrice}">
            </td>

            <td>
              <input type="number" class="form-control line-amount"
                     value="0" readonly>
            </td>

            <td>
              <button type="button" class="btn btn-sm btn-danger remove-item">삭제</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <button type="button" class="btn btn-sm btn-outline-primary" id="add-item">상품 추가</button>
    </div>

    <!-- 결제 금액 -->
    <div class="form-section">
      <h5 class="mb-3">결제 금액</h5>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">금액 (공급가액)</label>
          <input type="number" class="form-control" id="subtotal" value="0" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">세금 (VAT 10%)</label>
          <input type="number" class="form-control" id="tax" value="0" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">할인</label>
          <input type="number" class="form-control" id="discount" th:field="*{discount}">
        </div>
        <div class="col-md-3">
          <label class="form-label">총액</label>
          <input type="number" class="form-control" id="total" value="0" readonly>
        </div>
      </div>

      <!-- 서버로 함께 전송 -->
      <input type="hidden" id="subtotalHidden" th:field="*{subtotal}">
      <input type="hidden" id="taxHidden" th:field="*{tax}">
      <input type="hidden" id="totalHidden" th:field="*{total}">
    </div>

    <!-- 제출 버튼 -->
    <div class="text-end">
      <button type="submit" class="btn btn-success">수정 저장</button>
      <a th:href="@{/orders}" class="btn btn-outline-secondary">취소</a>
    </div>
  </form>

  <script>
    const orderItems = document.getElementById('order-items');
    const addItemBtn = document.getElementById('add-item');

    const subtotalInput = document.getElementById('subtotal');
    const taxInput = document.getElementById('tax');
    const discountInput = document.getElementById('discount');
    const totalInput = document.getElementById('total');

    const subtotalHidden = document.getElementById('subtotalHidden');
    const taxHidden = document.getElementById('taxHidden');
    const totalHidden = document.getElementById('totalHidden');

    function parseNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function updateAmounts() {
      let subtotal = 0;

      orderItems.querySelectorAll('tr.item-row').forEach(row => {
        const qty = parseNum(row.querySelector('.qty')?.value);
        const price = parseNum(row.querySelector('.unit-price')?.value);
        const amount = qty * price;

        const amountEl = row.querySelector('.line-amount');
        if (amountEl) amountEl.value = amount;

        subtotal += amount;
      });

      const tax = Math.floor(subtotal * 0.1);
      const discount = parseNum(discountInput.value);
      const total = subtotal + tax - discount;

      subtotalInput.value = subtotal;
      taxInput.value = tax;
      totalInput.value = total;

      subtotalHidden.value = subtotal;
      taxHidden.value = tax;
      totalHidden.value = total;
    }

    function reindexRows() {
      const rows = orderItems.querySelectorAll('tr.item-row');
      rows.forEach((row, idx) => {
        const no = row.querySelector('.row-no');
        if (no) no.textContent = String(idx + 1);

        const product = row.querySelector('.product-name');
        const qty = row.querySelector('.qty');
        const price = row.querySelector('.unit-price');

        if (product) product.name = `items[${idx}].productName`;
        if (qty) qty.name = `items[${idx}].qty`;
        if (price) price.name = `items[${idx}].unitPrice`;
      });
    }

    orderItems.addEventListener('input', (e) => {
      if (e.target.closest('tr.item-row')) updateAmounts();
    });

    discountInput.addEventListener('input', updateAmounts);

    addItemBtn.addEventListener('click', () => {
      const idx = orderItems.querySelectorAll('tr.item-row').length;

      const tr = document.createElement('tr');
      tr.className = 'item-row';
      tr.innerHTML = `
        <td class="row-no">${idx + 1}</td>
        <td><input type="text" class="form-control product-name" placeholder="상품명" name="items[${idx}].productName"></td>
        <td><input type="number" class="form-control qty" value="1" min="1" name="items[${idx}].qty"></td>
        <td><input type="number" class="form-control unit-price" value="0" min="0" name="items[${idx}].unitPrice"></td>
        <td><input type="number" class="form-control line-amount" value="0" readonly></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-item">삭제</button></td>
      `;

      orderItems.appendChild(tr);
      reindexRows();
      updateAmounts();
    });

    orderItems.addEventListener('click', (e) => {
      if (!e.target.classList.contains('remove-item')) return;

      const row = e.target.closest('tr.item-row');
      if (!row) return;

      const rows = orderItems.querySelectorAll('tr.item-row');
      if (rows.length <= 1) {
        row.querySelector('.product-name').value = '';
        row.querySelector('.qty').value = 1;
        row.querySelector('.unit-price').value = 0;
      } else {
        row.remove();
      }

      reindexRows();
      updateAmounts();
    });

    // 초기 렌더링 시 기존 값 기준으로 자동 계산
    reindexRows();
    updateAmounts();
  </script>

</section>
</html>
