<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>
  <div class="d-flex align-items-center mb-3">
    <h2 class="fw-bold me-auto">근태 관리</h2>
    <a th:if="${session.auth != null and session.auth <= 2}" class="btn btn-sm btn-primary" th:href="@{/attendance/form}">등록</a>
  </div>

  <div class="card p-3 shadow-sm mb-3">
    <form th:action="@{/attendance}" method="get" class="row g-2 align-items-center mb-0">

      <!-- 검색 기준 -->
      <div class="col-auto">
        <select class="form-select form-select-sm" name="searchField">
          <option value="name" th:selected="${param.searchField == 'name' or #strings.isEmpty(param.searchField)}">이름</option>
          <option value="id" th:selected="${param.searchField == 'id'}">직원ID</option>
        </select>
      </div>

      <!-- 검색어 -->
      <div class="col-auto">
        <input class="form-control form-control-sm"
               type="text"
               name="keyword"
               placeholder="검색어 입력"
               th:value="${param.keyword}">
      </div>

      <!-- 날짜(달력) -->
      <div class="col-auto">
        <input class="form-control form-control-sm"
               type="date"
               name="workDate"
               th:value="${param.workDate}">
      </div>

      <!-- 상태 -->
      <div class="col-auto">
        <select class="form-select form-select-sm" name="status">
          <option value="" th:selected="${#strings.isEmpty(param.status)}">상태 전체</option>
          <option th:each="s : ${statuses}"
                  th:value="${s.name()}"
                  th:text="${s.name() == 'NORMAL' ? '출근' :
                            s.name() == 'LATE' ? '지각' :
                            s.name() == 'ABSENT' ? '결근' :
                            s.name() == 'ANNUAL' ? '연차' :
                            s.name() == 'SICK' ? '병가' :
                            s.name() == 'BUSINESS' ? '출장' : s.name()}"
                  th:selected="${param.status == s.name()}">
          </option>
        </select>
      </div>

      <!-- 조회 버튼 -->
      <div class="col-auto">
        <button class="btn btn-outline-secondary btn-sm" type="submit">조회</button>
      </div>

    </form>
  </div>

  <div class="card p-3 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
        <tr>
          <th>직원ID</th>
          <th>이름</th>
          <th>근무일</th>
          <th>출근</th>
          <th>퇴근</th>
          <th>상태</th>
          <th>초과분</th>
          <th>비고</th>
          <th style="width:110px;">관리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="a : ${attendanceList}">
          <td th:text="${a.employeeId}"></td>
          <td th:text="${a.employeeName}"></td>
          <td th:text="${a.workDate}"></td>
          <td th:text="${a.checkInTime}"></td>
          <td th:text="${a.checkOutTime}"></td>
		  <td th:text="${a.status == 'NORMAL' ? '출근' :
		                a.status == 'LATE' ? '지각' :
		                a.status == 'ABSENT' ? '결근' :
		                a.status == 'ANNUAL' ? '연차' :
		                a.status == 'SICK' ? '병가' :
		                a.status == 'BUSINESS' ? '출장' : a.status}">
		  </td>
          <td th:text="${a.overtimeMinutes}"></td>
          <td th:text="${a.note}"></td>
		  <td style="white-space:nowrap;">
		    <div th:if="${session.auth != null and session.auth <= 2}" class="d-flex flex-nowrap gap-1">
		      <a class="btn btn-sm btn-outline-primary text-nowrap"
		         th:href="@{/attendance/form(id=${a.attendanceId})}">수정</a>

		      <form th:action="@{/attendance/delete}" method="post" class="d-inline">
		        <input type="hidden" name="id" th:value="${a.attendanceId}">
		        <button type="submit"
		                class="btn btn-sm btn-outline-danger text-nowrap"
		                onclick="return confirm('삭제할까요')">삭제</button>
		      </form>
		    </div>
		  </td>
        </tr>

        <tr th:if="${#lists.isEmpty(attendanceList)}">
          <td colspan="9" class="text-center text-muted">데이터 없음</td>
        </tr>
        </tbody>
      </table>
	  <nav class="mt-3">
	    <ul class="pagination pagination-sm justify-content-center mb-0"
	        th:with="
	          tp=${totalPages == null ? 1 : totalPages},
	          cp=${currentPage == null ? 1 : currentPage},
	          start=${(cp - 2) < 1 ? 1 : (cp - 2)},
	          end=${(cp + 2) > tp ? tp : (cp + 2)}
	        ">

	      <li class="page-item" th:classappend="${cp <= 1} ? ' disabled' : ''">
	        <a class="page-link"
	           th:href="@{/attendance(searchField=${param.searchField}, keyword=${param.keyword}, workDate=${param.workDate}, status=${param.status}, page=${cp - 1})}">
	          이전
	        </a>
	      </li>

	      <li class="page-item" th:if="${start > 1}">
	        <a class="page-link"
	           th:href="@{/attendance(searchField=${param.searchField}, keyword=${param.keyword}, workDate=${param.workDate}, status=${param.status}, page=1)}">1</a>
	      </li>

	      <li class="page-item disabled" th:if="${start > 2}">
	        <span class="page-link">...</span>
	      </li>

	      <li class="page-item"
	          th:each="p : ${#numbers.sequence(start, end)}"
	          th:classappend="${p == cp} ? ' active' : ''">
	        <a class="page-link"
	           th:href="@{/attendance(searchField=${param.searchField}, keyword=${param.keyword}, workDate=${param.workDate}, status=${param.status}, page=${p})}"
	           th:text="${p}">1</a>
	      </li>

	      <li class="page-item disabled" th:if="${end < tp - 1}">
	        <span class="page-link">...</span>
	      </li>

	      <li class="page-item" th:if="${end < tp}">
	        <a class="page-link"
	           th:href="@{/attendance(searchField=${param.searchField}, keyword=${param.keyword}, workDate=${param.workDate}, status=${param.status}, page=${tp})}"
	           th:text="${tp}">10</a>
	      </li>

	      <li class="page-item" th:classappend="${cp >= tp} ? ' disabled' : ''">
	        <a class="page-link"
	           th:href="@{/attendance(searchField=${param.searchField}, keyword=${param.keyword}, workDate=${param.workDate}, status=${param.status}, page=${cp + 1})}">
	          다음
	        </a>
	      </li>

	    </ul>
	  </nav>

    </div>
  </div>
</section>
</body>
</html>
