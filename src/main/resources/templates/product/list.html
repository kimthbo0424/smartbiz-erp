<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>

<h2 class="fw-bold mb-4">상품 목록</h2>

<!-- 정렬 + 등록 -->
<div class="d-flex justify-content-between mb-3">
    <select id="sortSelect" class="form-select" style="width:220px"
            onchange="resetAndLoad()">
        <option value="recent_desc">등록순 (최신)</option>
        <option value="recent_asc">등록순 (오래된순)</option>
        <option value="name_asc">이름순 (A → Z)</option>
        <option value="name_desc">이름순 (Z → A)</option>
    </select>

    <a href="/product/create" class="btn btn-primary">상품 등록</a>
</div>

<!-- 테이블 -->
<div class="table-responsive bg-white rounded shadow-sm">
<table class="table table-hover align-middle">
    <thead class="table-light">
    <tr>
        <th>ID</th>
        <th>상품명</th>
        <th>SKU</th>
        <th>카테고리</th>
        <th>상태</th>
        <th style="width:120px">액션</th>
    </tr>
    </thead>
    <tbody id="productBody"></tbody>
</table>
</div>

<!-- 페이지 -->
<nav class="mt-3">
    <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>

<script>
let currentPage = 0;
const pageSize = 10;

document.addEventListener("DOMContentLoaded", loadProducts);

function resetAndLoad() {
    currentPage = 0;
    loadProducts();
}

async function loadProducts() {
    const sort = document.getElementById("sortSelect").value;

    const res = await fetch(
        `/api/products?page=${currentPage}&size=${pageSize}&sort=${sort}`
    );
    const result = await res.json();

    if (!result.success) {
        alert("상품 조회 실패");
        return;
    }

    renderProducts(result.data.content);
    renderPagination(result.data.totalPages);
}

function renderProducts(list) {
    const tbody = document.getElementById("productBody");
    tbody.innerHTML = "";

    if (list.length === 0) {
        tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-muted">
                상품이 없습니다.
              </td>
            </tr>`;
        return;
    }

    list.forEach(p => {
        tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td>${p.sku}</td>
                <td>${p.categoryName ?? "-"}</td>
                <td>${p.status}</td>
                <td>
                    <a href="/product/detail/${p.id}"
                       class="btn btn-sm btn-secondary">보기</a>
                </td>
            </tr>
        `);
    });
}

function renderPagination(totalPages) {
    const ul = document.getElementById("pagination");
    ul.innerHTML = "";

    for (let i = 0; i < totalPages; i++) {
        ul.insertAdjacentHTML("beforeend", `
            <li class="page-item ${i === currentPage ? "active" : ""}">
                <button class="page-link"
                        onclick="goPage(${i})">${i + 1}</button>
            </li>
        `);
    }
}

function goPage(page) {
    currentPage = page;
    loadProducts();
}
</script>

</section>
</body>
</html>
