<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>

<section>
  <h2 class="fw-bold mb-4">재고 리포트</h2>

  <!-- 창고 선택 -->
  <div class="mb-3">
    <select id="warehouseSelect" class="form-select">
      <option value="">창고 선택</option>
    </select>
  </div>

  <div class="bg-white p-4 rounded shadow-sm">

    <!-- 그래프 -->
    <div class="row">
      <div class="col-md-6">
        <canvas id="inOutChart" height="150"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="stockTrendChart" height="150"></canvas>
      </div>
    </div>

    <!-- 요약 -->
    <div class="row mt-4 text-center">
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted small">총 입고 수량</div>
            <div id="totalIn" class="fw-bold fs-5 text-success">0</div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted small">총 출고 수량</div>
            <div id="totalOut" class="fw-bold fs-5 text-danger">0</div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted small">재고 변동률</div>
            <div id="stockChangeRate" class="fw-bold fs-5 text-primary">0%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let inOutChart = null;
    let stockTrendChart = null;

    // 요약 초기화
    function resetSummary() {
      document.getElementById("totalIn").innerText = "0";
      document.getElementById("totalOut").innerText = "0";
      document.getElementById("stockChangeRate").innerText = "0%";
    }

    // 창고 목록
    async function loadWarehouses() {
      const res = await fetch("/api/warehouse");
      const list = await res.json();

      const select = document.getElementById("warehouseSelect");
      select.innerHTML = `<option value="">창고 선택</option>`;

      list.forEach(w => {
        select.insertAdjacentHTML(
          "beforeend",
          `<option value="${w.id}">${w.name}</option>`
        );
      });
    }

    // 리포트 로드
    async function loadReport() {
  const warehouseId = document.getElementById("warehouseSelect").value;

  resetSummary();
  if (!warehouseId) return;

  try {
    const moveRes =
      await fetch(`/api/inventory/moves/report?warehouseId=${warehouseId}`);
    const moveJson = await moveRes.json();

    const invRes =
      await fetch(`/api/inventory?warehouseId=${warehouseId}&page=0&size=100`);
    const invJson = await invRes.json();

    const moves =
      Array.isArray(moveJson.data) ? moveJson.data : [];

    const inventory =
      Array.isArray(invJson.data?.content)
        ? invJson.data.content
        : [];

    processReport(moves, inventory);

  } catch (err) {
    console.error("리포트 로드 실패:", err);
    resetSummary();
  }
}


    // 리포트 계산
    function processReport(moves, inventory) {
      let totalIn = 0;
      let totalOut = 0;
      const map = {};

      // 월별 입출고 + 총합 계산
      moves.forEach(m => {
        if (!m.occurredAt) return;

        const month = m.occurredAt.substring(0, 7);
        if (!map[month]) map[month] = { IN: 0, OUT: 0 };

        if (m.type === "IN") {
          map[month].IN += m.quantity;
          totalIn += m.quantity;
        } else if (m.type === "OUT") {
          map[month].OUT += m.quantity;
          totalOut += m.quantity;
        }
      });

      // 요약 표시
      document.getElementById("totalIn").innerText = totalIn;
      document.getElementById("totalOut").innerText = totalOut;

      // 안전재고 총합
      const safetyTotal =
        inventory.reduce((sum, i) => sum + (i.safetyStockQty ?? 0), 0);

      // 재고 변동률 (핵심 수정)
      // (총 입고 - 총 출고) / 안전재고 * 100
      const rate =
        safetyTotal === 0
          ? 0
          : (((totalIn - totalOut) / safetyTotal) * 100).toFixed(1);

      document.getElementById("stockChangeRate").innerText = rate + "%";

      // 차트 그리기
      drawCharts(map);
    }

    // 차트
    function drawCharts(data) {
      const labels = Object.keys(data).sort();
      const inData = labels.map(m => data[m].IN);
      const outData = labels.map(m => data[m].OUT);

      if (inOutChart) inOutChart.destroy();
      if (stockTrendChart) stockTrendChart.destroy();

      inOutChart = new Chart(
        document.getElementById("inOutChart"),
        {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "입고", data: inData },
              { label: "출고", data: outData }
            ]
          }
        }
      );

      let trend = [];
      let acc = 0;
      labels.forEach((_, i) => {
        acc += inData[i] - outData[i];
        trend.push(acc);
      });

      stockTrendChart = new Chart(
        document.getElementById("stockTrendChart"),
        {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: "재고 추이", data: trend }
            ]
          }
        }
      );
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadWarehouses();
      document
        .getElementById("warehouseSelect")
        .addEventListener("change", loadReport);
    });
  </script>
</section>
</body>
</html>
