<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>

  <h2 class="mb-3 fw-bold">ê³µê¸‰ì‚¬ ë“±ë¡</h2>

  <div class="card p-4 shadow-sm">

    <!-- ğŸ”¹ ìƒí’ˆ ID (ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë‚´ë ¤ì¤Œ) -->
    <input type="hidden" id="productId" th:value="${productId}">

    <div class="mb-3">
      <label class="form-label">ê³µê¸‰ì‚¬ (ê±°ë˜ì²˜)</label>
      <select id="supplierId" class="form-select" required>
        <option value="">ê³µê¸‰ì‚¬ ì„ íƒ</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">ê³µê¸‰ì‚¬ SKU</label>
      <input type="text" id="supplierSku" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">ë¦¬ë“œíƒ€ì„ (ì¼)</label>
      <input type="number" id="leadTime" class="form-control">
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="isPrimary">
      <label class="form-check-label">ëŒ€í‘œ ê³µê¸‰ì‚¬</label>
    </div>

    <div class="d-flex justify-content-between">
      <button class="btn btn-primary" onclick="submitCreate()">ì €ì¥</button>
      <a class="btn btn-secondary"
         th:href="@{|/product-supplier/product/${productId}|}">
        ì·¨ì†Œ
      </a>
    </div>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      loadSuppliers();
    });

    async function loadSuppliers() {
      const res = await fetch("/api/clients?type=SUPPLIER");
      const result = await res.json();

      if (!result.success) {
        alert("ê³µê¸‰ì‚¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");
        return;
      }

      const select = document.getElementById("supplierId");
      result.data.content.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
    }

    async function submitCreate() {
      const productId = Number(document.getElementById("productId").value);
      const supplierId = document.getElementById("supplierId").value;

      if (!supplierId) {
        alert("ê³µê¸‰ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const body = {
        productId: productId,
        supplierId: Number(supplierId),
        supplierSku: document.getElementById("supplierSku").value || null,
        leadTime: document.getElementById("leadTime").value
                  ? Number(document.getElementById("leadTime").value)
                  : null,
        isPrimary: document.getElementById("isPrimary").checked
      };
	
      const res = await fetch("/api/product-suppliers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (res.status === 201) {
        alert("ê³µê¸‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.href = `/product-supplier/product/${productId}`;
      } else {
        alert("ê³µê¸‰ì‚¬ ë“±ë¡ ì‹¤íŒ¨");
      }
    }
  </script>

</section>
</body>
</html>
