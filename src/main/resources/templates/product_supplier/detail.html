<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{base :: layout(~{::section})}">
<body>
<section>

<h2 class="fw-bold mb-4">ê³µê¸‰ì‚¬ ìƒì„¸ ì •ë³´</h2>

<div class="card shadow-sm p-4">

    <!-- ğŸ”¹ ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ supplierId -->
    <input type="hidden" id="supplierId" th:value="${supplierId}">
    <input type="hidden" id="productId">

    <div class="mb-3">
        <strong>ê³µê¸‰ì‚¬(ê±°ë˜ì²˜)</strong>
        <div class="form-control-plaintext" id="supplierName"></div>
    </div>

    <div class="mb-3">
        <label class="form-label">ê³µê¸‰ì‚¬ SKU</label>
        <input type="text" id="supplierSku" class="form-control">
    </div>

    <div class="mb-3">
        <label class="form-label">ë¦¬ë“œíƒ€ì„ (ì¼)</label>
        <input type="number" id="leadTime" class="form-control">
    </div>

    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="isPrimary">
        <label class="form-check-label">ëŒ€í‘œ ê³µê¸‰ì‚¬</label>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-secondary" onclick="goList()">ëª©ë¡ìœ¼ë¡œ</button>
        <div>
            <button class="btn btn-danger me-2" onclick="deleteSupplier()">ì‚­ì œ</button>
            <button class="btn btn-primary" onclick="save()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
const supplierId = document.getElementById("supplierId").value;

document.addEventListener("DOMContentLoaded", loadSupplier);

async function loadSupplier() {
    const res = await fetch(`/api/product-suppliers/${supplierId}`);
    const result = await res.json();

    if (!result.success) {
        alert("ê³µê¸‰ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
    }

    const s = result.data;

    document.getElementById("supplierName").innerText = s.supplierName;
    document.getElementById("supplierSku").value = s.supplierSku ?? "";
    document.getElementById("leadTime").value = s.leadTime ?? "";
    document.getElementById("isPrimary").checked = s.isPrimary === true;

    // ëª©ë¡ ë³µê·€ìš©
    document.getElementById("productId").value = s.productId;
}

async function save() {
    const body = {
        supplierSku: document.getElementById("supplierSku").value || null,
        leadTime: document.getElementById("leadTime").value
                  ? Number(document.getElementById("leadTime").value)
                  : null,
        isPrimary: document.getElementById("isPrimary").checked
    };

    const res = await fetch(`/api/product-suppliers/${supplierId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    if (res.ok) {
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        goList();
    } else {
        alert("ì €ì¥ ì‹¤íŒ¨");
    }
}

async function deleteSupplier() {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const res = await fetch(`/api/product-suppliers/${supplierId}`, {
        method: "DELETE"
    });

    if (res.status === 204) {
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        goList();
    } else {
        alert("ì‚­ì œ ì‹¤íŒ¨");
    }
}

function goList() {
    const productId = document.getElementById("productId").value;
    location.href = `/product-supplier/product/${productId}`;
}
</script>

</section>
</body>
</html>
